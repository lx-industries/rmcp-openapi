# Common file patterns for Rust jobs
.rust-changes: &rust-changes
  - "Cargo.toml"
  - "Cargo.lock"
  - "crates/**/*"
  - "tests/**/*"
  - "examples/**/*"
  - ".cargo/**/*"
  - ".gitlab/ci/rust.gitlab-ci.yml" # Watch the Rust CI config file

# Cache configuration patterns for optimal build performance
.cargo-registry-cache: &cargo-registry-cache
  key: $CI_COMMIT_REF_SLUG
  paths:
    # https://doc.rust-lang.org/cargo/guide/cargo-home.html?highlight=CI%20cache#caching-the-cargo-home-in-ci
    - ".cargo/.crates.toml"
    - ".cargo/.crates2.json"
    - ".cargo/bin/"
    - ".cargo/registry/index/"
    - ".cargo/registry/cache/"
    - ".cargo/registry/src/"
    - ".cargo/git/db/"
  policy: pull

.cargo-build-cache: &cargo-build-cache
  key: $CI_COMMIT_REF_SLUG-$CI_JOB_NAME_SLUG
  paths:
    # https://doc.rust-lang.org/cargo/guide/build-cache.html
    - "target"
  policy: pull-push

# Unified Rust job template - consolidated configuration for all Rust jobs
.rust-template:
  image: registry.gitlab.com/lx-industries/rmcp-openapi/images/rust:1.93.0-x86_64-unknown-linux-gnu@sha256:b0a6871f507770a085fa1bbcb1ed102d8639b77901f4e68816ffae3fe0945e71
  variables:
    # Assume the PWD is CI_PROJECT_DIR, this way we don't have to deal with
    # Windows (`\`) vs Linux (`/`) path separators.
    CARGO_HOME: ".cargo"
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes: *rust-changes
    - if: "$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH"
      changes: *rust-changes
  before_script:
    - rustc --version
    - cargo --version
  interruptible: true

# Build job - compile the project
build:
  extends:
    - .rust-template
    - .sccache-rust
  stage: build
  before_script:
    - !reference [.sccache-rust, before_script]
    - !reference [.rust-template, before_script]
  script:
    - cargo build --workspace --all-features --verbose
    - sccache --show-stats || true
  cache:
    - <<: *cargo-registry-cache
    - <<: *cargo-build-cache

# Test job - run unit tests only (excluding integration tests)
test:
  extends:
    - .rust-template
    - .sccache-rust
  stage: test
  before_script:
    - !reference [.sccache-rust, before_script]
    - !reference [.rust-template, before_script]
  script:
    - cargo test --workspace --verbose --lib --bins
    - sccache --show-stats || true
  cache:
    - <<: *cargo-registry-cache
    - <<: *cargo-build-cache
      policy: pull
  dependencies:
    - build

# Clippy job - run linting
clippy:
  extends:
    - .rust-template
    - .sccache-rust
  stage: lint
  before_script:
    - !reference [.sccache-rust, before_script]
    - !reference [.rust-template, before_script]
    - rustup component add clippy
    - cargo clippy --version
  script:
    - cargo clippy --workspace --all-targets --all-features -- -D warnings
    - sccache --show-stats || true
  cache:
    - <<: *cargo-registry-cache
    - <<: *cargo-build-cache
      policy: pull
  dependencies:
    - build

# Format job - check code formatting
fmt:
  extends: .rust-template
  stage: lint
  before_script:
    - !reference [.rust-template, before_script]
    - rustup component add rustfmt
    - cargo fmt --version
  script:
    - cargo fmt --all -- --check
  cache:
    - <<: *cargo-registry-cache

# Typos job - check for spelling errors
typos:
  extends: .rust-template
  stage: lint
  needs: []
  before_script:
    - typos --version
  script:
    - typos

# Documentation job - build and check rustdoc
rustdoc:
  extends:
    - .rust-template
    - .sccache-rust
  stage: docs
  before_script:
    - !reference [.sccache-rust, before_script]
    - !reference [.rust-template, before_script]
  script:
    # Build documentation with all features and check for warnings
    - cargo doc --workspace --all-features --no-deps 2>&1 | tee doc-output.txt
    - '! grep -E "warning.*missing documentation" doc-output.txt || (echo "Missing documentation found!" && exit 1)'
    # Also build with private items to ensure internal documentation is complete
    - cargo rustdoc --package rmcp-openapi --lib -- --document-private-items
    - sccache --show-stats || true
  cache:
    - <<: *cargo-registry-cache
    - <<: *cargo-build-cache
      policy: pull
  dependencies:
    - build
  artifacts:
    paths:
      - target/doc
      - doc-output.txt
    expire_in: 1 week
    when: always

# Documentation examples job - ensure all documentation examples compile
doc-test:
  extends:
    - .rust-template
    - .sccache-rust
  stage: docs
  before_script:
    - !reference [.sccache-rust, before_script]
    - !reference [.rust-template, before_script]
  script:
    # Run documentation tests to ensure examples compile
    - cargo test --workspace --doc --all-features
    - sccache --show-stats || true
  cache:
    - <<: *cargo-registry-cache
    - <<: *cargo-build-cache
      policy: pull
  dependencies:
    - build

# Examples job - build all examples
examples:
  extends:
    - .rust-template
    - .sccache-rust
  stage: examples
  before_script:
    - !reference [.sccache-rust, before_script]
    - !reference [.rust-template, before_script]
  script:
    - cargo build --workspace --examples --verbose
    - sccache --show-stats || true
  cache:
    - <<: *cargo-registry-cache
    - <<: *cargo-build-cache
      policy: pull
  dependencies:
    - build

# Integration test with JavaScript/Node.js
integration-js:
  extends:
    - .rust-template
    - .sccache-rust
  stage: integration
  before_script:
    - !reference [.sccache-rust, before_script]
    - !reference [.rust-template, before_script]
    - apt-get update -qq && apt-get install -y -qq curl
    - curl -fsSL https://nodejs.org/dist/v20.11.1/node-v20.11.1-linux-x64.tar.xz | tar -xJ -C /usr/local --strip-components=1
    - node --version
    - npm --version
  script:
    - cargo test --package rmcp-openapi --test test_with_js --verbose
    - sccache --show-stats || true
  cache:
    - <<: *cargo-registry-cache
    - <<: *cargo-build-cache
      policy: pull
  dependencies:
    - build
  interruptible: true
